Using PaladinHub.Models.Products
@model PaladinHub.Models.Products.ProductDetailsViewModel
@{
    ViewData["Title"] = Model.Name;
    var rounded = (int)Math.Round(Model.AverageRating);
}

@if (TempData["ImgOk"] != null)
{
    <div class="alert alert-success alert-dismissible fade show alert-floating" role="alert">
        <i class="fa fa-check"></i> Image list updated.
    </div>
}
@if (TempData["ImgError"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show alert-floating" role="alert">
        <i class="fa fa-exclamation-circle"></i> @TempData["ImgError"]
    </div>
}

<div class="container my-4">
    <div class="row g-4">
        <!-- Gallery (read-only) -->
        <div class="col-12 col-lg-5">
            <partial name="_ProductGallery" model="Model" />
        </div>

        <!-- Info -->
        <div class="col-12 col-lg-7">
            <h2 class="mb-2">@Model.Name</h2>

            <div class="product-meta d-flex flex-wrap align-items-center gap-3 text-muted mb-2">
                <span>Category: <span class="text-reset fw-semibold">@Model.Category</span></span>
                <span class="vr d-none d-sm-inline"></span>
                <span class="rating text-warning">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= rounded)
                        {
                            <i class="fa-solid fa-star"></i>
                        }
                        else
                        {

                            <i class="fa-regular fa-star"></i>
                        }
                    }
                    <span class="small text-muted ms-1">(@Model.ReviewsCount)</span>
                </span>
            </div>

            <div class="fs-3 fw-bold text-success mb-3">@Model.Price.ToString("0.##") лв.</div>

            @if (!string.IsNullOrWhiteSpace(Model.Description))
            {
                <p class="mb-4">@Model.Description</p>
            }

            <div class="d-flex gap-2 mb-4">
                <a class="btn btn-warning fw-bold"
                   asp-controller="Carts" asp-action="AddProduct" asp-route-id="@Model.Id">
                    <i class="fa-solid fa-cart-plus me-1"></i> Add to Cart
                </a>
                <a class="btn btn-outline-light" asp-controller="Merchandise" asp-action="Merchandise">Back</a>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mt-4" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-reviews" type="button">
                Reviews (@Model.ReviewsCount)
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-similar" type="button">
                Similar
            </button>
        </li>
    </ul>

    <div class="tab-content bg-dark rounded-bottom p-3 border border-top-0">
        <!-- REVIEWS -->
        <div class="tab-pane fade show active" id="tab-reviews">
            @if (User.Identity?.IsAuthenticated ?? false)
            {
                <form asp-action="AddReview" method="post" class="mb-4">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ProductId" value="@Model.Id" />
                    <div class="row g-2 align-items-center">
                        <div class="col-auto"><label class="form-label mb-0 me-2">Your rating</label></div>
                        <div class="col-auto">
                            <select name="Rating" class="form-select form-select-sm">
                                @for (var r = 5; r >= 1; r--)
                                {
                                    <option value="@r">@r</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 col-md">
                            <input name="Content" class="form-control form-control-sm" placeholder="Share your thoughts…" />
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-warning btn-sm fw-bold" type="submit">Submit</button>
                        </div>
                    </div>
                </form>
            }
            else
            {
                <div class="alert alert-secondary">Login to leave a review.</div>
            }

            @if (Model.Reviews.Count == 0)
            {
                <div class="text-muted">No reviews yet.</div>
            }
            else
            {
                <ul class="list-unstyled">
                    @foreach (var r in Model.Reviews)
                    {
                        <li class="py-3 border-bottom border-secondary review-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-semibold review-user">@r.UserName</div>
                                    <div class="text-warning small">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= r.Rating)
                                            {
                                                <i class="fa-solid fa-star"></i>
                                            }
                                            else
                                            {

                                                <i class="fa-regular fa-star"></i>
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="text-nowrap small text-muted">@r.CreatedAt.ToLocalTime().ToString("g")</div>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(r.Content))
                            {
                                <div class="mt-2">@r.Content</div>
                            }

                            @if (r.CanDelete)
                            {
                                <form asp-action="DeleteReview" method="post" class="mt-2">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@r.Id" />
                                    <input type="hidden" name="productId" value="@Model.Id" />
                                    <button class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            }
                        </li>
                    }
                </ul>
            }
        </div>

        <!-- SIMILAR -->
        <div class="tab-pane fade" id="tab-similar">
            @if (Model.Similar.Count == 0)
            {
                <div class="text-muted">No similar products.</div>
            }
            else
            {
                <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 g-3">
                    @foreach (var s in Model.Similar)
                    {
                        <div class="col">
                            <div class="card product-card h-100 position-relative">
                                <img src="@(string.IsNullOrWhiteSpace(s.ImageUrl) ? Url.Content("~/images/placeholder.png") : s.ImageUrl)"
                                     class="card-img-top" alt="@s.Name" />
                                <div class="card-body">
                                    <h6 class="card-title text-truncate mb-1">@s.Name</h6>
                                    <div class="price fw-semibold">@s.Price.ToString("0.##") лв.</div>
                                </div>
                                <div class="card-footer bg-transparent border-0 pt-0">
                                    <a asp-controller="Carts" asp-action="AddProduct" asp-route-id="@s.Id"
                                       class="btn btn-primary btn-sm w-100">Add to Cart</a>
                                </div>
                                <a asp-controller="Products" asp-action="Details" asp-route-id="@s.Id"
                                   class="stretched-link" aria-label="@s.Name"></a>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<style>
    .alert-floating {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1080
    }

    .nav-tabs .nav-link {
        color: #ddd
    }

        .nav-tabs .nav-link.active {
            color: #000;
            background: #f59f00;
            border-color: #f59f00
        }

    .tab-content {
        border-radius: .5rem
    }

    .product-card {
        position: relative
    }

    .price {
        color: #9bd66f
    }

    /* леки акценти за мета и ревюта */
    .product-meta .rating i {
        margin-right: 1px
    }

    .review-item .review-user {
        color: #e6e6e6
    }

    .review-item i.fa-star {
        margin-right: 1px
    }
</style>

<script>
    setTimeout(function(){
      document.querySelectorAll('.alert-floating').forEach(el=>el.style.display='none');
    },1600);
</script>
